<head>
	<meta charset="utf-8" />
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-101258980-5"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'UA-101258980-5');
	</script>
	<script>
		var chars = [];
		var eds = [];
		var rps = [];
		var eks = [];
		var ms = [];
		var prioridadeChars = [];
		var insuficiente = false;

		function processar() {
			var prioridade = document.getElementById("prioridade");
			var charNames = new Set();
			var charsPrioridade = prioridade.value.split(", ");
			console.log(charsPrioridade);
			var text = document.getElementById("localchat");
			var lines = text.value.split("\n");

			for (i = 0; i < lines.length; i++) {
				if (lines[i].includes("[")) {
					var splitted = lines[i].split(" ");
					charName = "";
					index = 1
					while (!splitted[index].includes("[")) {
						charName += " " + splitted[index];
						index++;
					}
					charNames.add(charName);
				}

			}
			for (let charName of charsPrioridade) {
				var char = getCharInfo(charName);
				if (char != null) {
					prioridadeChars.push(char);
				}

			}

			for (let charName of charNames) {
				var char = getCharInfo(charName);
				if (char != null) {
					chars.push(char);
				}
			}
			console.log(chars);
			console.log(prioridadeChars);
			countVocations(chars);
		}

		function printPool(pool) {

			var names = 'Pool: ';
			for (let char of pool) names += ' ' + char.name
			console.log(names)
		}

		function showTeam(team, message, result) {
			if (!insuficiente) {
				var names = message + ' ';
				for (let char of team) names += ' ' + char.name + ",";
				result.innerHTML += names + "<br>";
			}
		}

		function removeItem(list, name) {
			if (list.length > 0) {
				var index = 0;
				var found = false;
				for (let item of list) {
					if (item.name == name) {
						found = true;
						break;
					}
					index++;
				}
				if (found) {
					list.splice(index, 1);
				}
			}
		}

		function alocate(team, pool, amount, subs) {
			if (pool.length > 0) {
				console.log("Allocating " + amount + " of vocation: " + pool[0].vocation);
				printPool(pool);
			}

			for (x = 0; x < amount; x++) {
				if (pool.length > 0) {
					var found = false;
					if (prioridadeChars.length > 0) {
						for (let char of prioridadeChars) {
							if (char != null) {
								if (char.vocation == pool[0].vocation) {
									console.log("Allocating prioridade: " + char.name);
									removeItem(prioridadeChars, char.name);
									removeItem(pool, char.name);
									found = true;
									team.push(char);
									printPool(pool);
									break;
								}
							}
						}
					}
					if (!found) {
						var sorteado = pool[Math.floor(Math.random() * pool.length)];
						console.log(sorteado);
						removeItem(pool, sorteado.name);
						team.push(sorteado);
						printPool(pool);
					}


				} else {
					if (!subs) {
						result.innerHTML = "Número insuficiente de pessoas pra formação desejada. Por favor, limpe os times e comece novamente. <br>"
						insuficiente = true;
					}
					return;
				}
			}
		}

		function limparTimes() {
			location.reload();
		}

		function formarTimes() {
			var qtyEds = document.getElementById("qtyEds").value;
			var qtyEks = document.getElementById("qtyEks").value;
			var qtyRps = document.getElementById("qtyRps").value;
			var qtyMs = document.getElementById("qtyMs").value;
			var subs = document.getElementById("subs").checked;
			var qty = document.getElementById("qty").value;
			var result = document.getElementById("result");
			for (i = 0; i < qty; i++) {
				if (!insuficiente) {
					console.log("time " + (i + 1) + ": ");
					var team = [];
					alocate(team, eds, qtyEds, false);
					alocate(team, eks, qtyEks, false);
					var msInTeam = ms.length < qtyMs ? ms.length : qtyMs;
					alocate(team, ms, qtyMs, subs);
					alocate(team, rps, qtyRps, false);
					if (msInTeam < qtyMs) {
						var diff = qtyMs - msInTeam;
						if (rps.length >= diff) {
							alocate(team, rps, diff, false);
						} else {
							diff = diff - rps.length;
							alocate(team, rps, rps.length, subs);
							alocate(team, eds, diff, false);
						}
					}
					console.log(team);
					showTeam(team, "time " + (i + 1) + ": ", result);
				}
			}
			if (!insuficiente) {
				var leftOver = ''
				for (let char of eds) leftOver += char.name + ", ";
				for (let char of rps) leftOver += char.name + ", ";
				for (let char of eks) leftOver += char.name + ", ";
				for (let char of ms) leftOver += char.name + ", ";
				if (leftOver[leftOver.length - 1] == " ") {
					leftOver = leftOver.slice(0, -2);
					console.log(leftOver);
				}
				result.innerHTML += "<br> Prioridade amanhã: " + leftOver;
				localStorage.setItem("prioridade", leftOver);
			}
		}

		function countVocations(chars) {
			for (let char of chars) {
				if (char.vocation == "Elder Druid") {
					eds.push(char);
				}
				if (char.vocation == "Master Sorcerer") {
					ms.push(char);
				}
				if (char.vocation == "Elite Knight") {
					eks.push(char);
				}
				if (char.vocation == "Royal Paladin") {
					rps.push(char);
				}
			}

			var divVocations = document.getElementById("vocations");
			divVocations.style.visibility = "visible";
			document.getElementById("eks").innerHTML = eks.length;
			document.getElementById("rps").innerHTML = rps.length;
			document.getElementById("ms").innerHTML = ms.length;
			document.getElementById("eds").innerHTML = eds.length;
			document.getElementById("total").innerHTML = chars.length;

		}

		function getCharInfo(name) {
			try {
				var char = localStorage.getItem(name);
				if (char == null) {
					var request = httpGet(name);
					var char = JSON.parse(request).characters.data;
					localStorage.setItem(name, JSON.stringify(char));
				} else {
					char = JSON.parse(char);
				}

				return char;
			} catch (e) {
				console.log(e);
			}
			return null;
		}

		function httpGet(name) {
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.open("GET", "https://api.tibiadata.com/v2/characters/" + name + ".json", false);
			xmlHttp.send(null);
			return xmlHttp.responseText;
		}
		function fill() {
			var prioridade = localStorage.getItem("prioridade");
			document.getElementById("prioridade").value = prioridade;
		}

		function resetarPrioridade() {
			localStorage.removeItem("prioridade");
		}
	</script>
</head>

<body onload=fill()>
	<table>
		<tr>
			<td>
				<ul>
					<li>Limpe o local chat</li>
					<li>Peça que todos mandem uma única mensagem no chat</li>
					<li>Selecione todo o local chat e copie</li>
					<li>Cole abaixo</li>
				</ul>
				<textarea id="localchat" style="width:300; height:300">
21:14 Conitio [525]: exeta res
21:14 Roshoot [403]: exevo mas san
21:14 Marujo Tatuado [454]: exura gran san
21:14 Roshoot [403]: exura gran san
21:14 Conitio [525]: exori min
21:14 Taylon Terni [776]: exeta res
21:14 Creitos [566]: exura gran mas res
21:14 Roshoot [403]: exura gran san
21:14 Marujo Tatuado [454]: exura gran san
21:14 Conitio [525]: exeta res
21:14 Taylon Terni [776]: exeta res
21:14 Roshoot [403]: exura gran san
21:14 Conitio [525]: exori mas
21:14 Druidinho Bala [525]: exori mas
21:14 Lopexx [525]: exori mas
21:14 Bro [525]: exori mas
21:14 Lopexx [525]: exori mas
21:14 Beth Swain [525]: exori mas
21:14 Grusby [525]: exori mas
21:14 Jharp [525]: exori mas
21:14 Meu Binhu [525]: exori mas
21:14 Roshoot [525]: exori mas
21:14 Yavii [525]: exori mas
21:14 Mahtynho [525]: exori mas
21:14 Re Fry [525]: exori mas
21:14 Zeitonah [525]: exori mas
21:14 Ikido [525]: exori mas
21:14 Maaycon [525]: exori mas
21:14 Girtrudes [525]: exori mas
21:14 Pakitzz [525]: exori mas
21:14 Sonekka [525]: exori mas
21:14 Druid Cervejeiro [525]: exori mas
21:14 Heal Raizer [525]: exori mas
		</textarea><br>
				Prioridade hoje: <br> (coloque os nomes certos, separados com vírgula e espaço):<br>
				<input type="text" id="prioridade">
				<button onclick=processar()>Processar</button>
			</td>
			<td>
				<div id="vocations" style=visibility:hidden>
					<center>
						<h1>PARTICIPANTES:</h1>
					</center><br />
					<h3>Royal paladins: <span id="rps"></span></h3>
					<h3>Elder druids: <span id="eds"></span></h3>
					<h3>Master sorcerers: <span id="ms"></span></h3>
					<h3>Elite knights: <span id="eks"></span></h3>
					<h3>Total: <span id="total"></span></h3>
					<h3>Estrutura do time:</h3>
					<table>
						<tr>
							<td>Quantidade de times:</td>
							<td><input type=text id="qty"></td>
						</tr>
						<tr>
							<td>Quantidade de EDs por time:</td>
							<td><input type=text id="qtyEds"></td>
						</tr>
						<tr>
							<td>Quantidade de EKs por time:</td>
							<td><input type=text id="qtyEks"></td>
						</tr>
						<tr>
							<td>Quantidade de RPs por time:</td>
							<td><input type=text id="qtyRps"></td>
							<td>
						</tr>
						<tr>
							<td>Quantidade de MS por time:</td>
							<td><input type=text id="qtyMs"><input type=checkbox id="subs">Substituivel</input></td>
						</tr>
					</table>
					<button onclick=formarTimes()>Formar times</button>
					<button onclick=limparTimes()>Limpar times</button>
					<button onclick=resetarPrioridade()>Resetar prioridade salva</button>
				</div>
			</td>
		</tr>
	</table>
	<div id="result">

	</div>
</body>